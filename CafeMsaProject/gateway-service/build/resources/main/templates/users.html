<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cafe MSA · 관리자</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- ✅ 공통 스타일 -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="body-cream">

<!-- ✅ NAV: 공통 fragment -->
<div th:replace="~{fragments/nav :: mainNav}"></div>

<main class="main-content">
    <!-- CONTENT -->
    <div class="container py-4">
        <div class="d-flex align-items-center mb-3">
            <h2 class="page-title mb-0">
                <i class="bi bi-people me-2"></i>사용자 관리
            </h2>
        </div>

        <div class="card panel-card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-cafe align-middle">
                        <thead>
                        <tr>
                            <th style="width:100px;">ID</th>
                            <th>사용자명</th>
                            <th>이메일</th>
                            <th style="width:180px;">역할</th>
                            <th style="width:220px;">작업</th>
                        </tr>
                        </thead>
                        <tbody id="userTableBody">
                        <!-- rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>사용자 정보 수정
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">사용자명</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">이메일</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">역할</label>
                        <select class="form-select" id="editRole" required>
                            <option value="ROLE_USER">ROLE_USER</option>
                            <option value="ROLE_OWNER">ROLE_OWNER</option>
                        </select>
                    </div>
                </form>
                <div class="small text-muted">
                    * 역할 값은 반드시 <code>ROLE_*</code> 포맷으로 저장됩니다.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" id="saveBtn" class="btn btn-primary">
                    <span class="save-text">저장</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ FOOTER: 공통 fragment -->
<div th:replace="~{fragments/footer :: mainFooter}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- 공통 네비/로그인 상태 관리 -->
<script th:src="@{/js/nav-common.js}"></script>
<script>
    let editModal;

    // 안전 텍스트 출력
    function text(node, value) {
        node.textContent = value == null ? '' : String(value);
    }

    // 역할 문자열 정규화
    function normalizeRole(role){
        if (!role) return null;
        if (role === 'OWNER') return 'ROLE_OWNER';
        if (role === 'USER')  return 'ROLE_USER';
        return role; // 이미 ROLE_* 인 경우
    }

    // 사용자 목록 로드
    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });

            if (response.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }
            if (response.status === 403) {
                alert('접근 권한이 없습니다.');
                window.location.href = '/';
                return;
            }

            if (!response.ok) {
                const txt = await response.text();
                console.error('Load users failed:', txt);
                alert('사용자 정보를 불러오는데 실패했습니다.');
                return;
            }

            const users = await response.json();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';

            users.forEach(u => {
                const tr = document.createElement('tr');

                const tdId = document.createElement('td');
                text(tdId, u.id);

                const tdUsername = document.createElement('td');
                text(tdUsername, u.username);

                const tdEmail = document.createElement('td');
                text(tdEmail, u.email);

                const tdRole = document.createElement('td');
                const badge = document.createElement('span');
                badge.className = 'role-badge';
                text(badge, normalizeRole(u.role) ?? '-');
                tdRole.appendChild(badge);

                const tdActions = document.createElement('td');

                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn btn-sm btn-primary me-2';
                btnEdit.type = 'button';
                btnEdit.innerHTML = '<i class="bi bi-pencil-square me-1"></i>수정';
                btnEdit.addEventListener('click', () =>
                    showEditModal(u.id, u.username, u.email, normalizeRole(u.role))
                );

                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-sm btn-danger';
                btnDelete.type = 'button';
                btnDelete.innerHTML = '<i class="bi bi-trash me-1"></i>삭제';
                btnDelete.addEventListener('click', () => deleteUser(u.id));

                tdActions.appendChild(btnEdit);
                tdActions.appendChild(btnDelete);

                tr.appendChild(tdId);
                tr.appendChild(tdUsername);
                tr.appendChild(tdEmail);
                tr.appendChild(tdRole);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error('Error(loadUsers):', e);
            alert('오류가 발생했습니다.');
        }
    }

    // 수정 모달 표시
    function showEditModal(id, username, email, role) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username ?? '';
        document.getElementById('editEmail').value = email ?? '';
        document.getElementById('editRole').value = normalizeRole(role) ?? 'ROLE_USER';

        if (!editModal) {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
        }
        editModal.show();
    }

    // 저장 버튼 상태 토글
    function toggleSaving(isSaving){
        const btn = document.getElementById('saveBtn');
        const spin = btn.querySelector('.spinner-border');
        const txt = btn.querySelector('.save-text');
        btn.disabled = isSaving;
        spin.classList.toggle('d-none', !isSaving);
        txt.classList.toggle('d-none', isSaving);
    }

    // 사용자 정보 수정
    async function updateUser() {
        const id = document.getElementById('editUserId').value;
        const username = document.getElementById('editUsername').value?.trim();
        const email = document.getElementById('editEmail').value?.trim();
        let role = normalizeRole(document.getElementById('editRole').value);

        if (!username || !email || !role){
            alert('모든 필드를 입력해 주세요.');
            return;
        }

        toggleSaving(true);
        try {
            const response = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ username, email, role })
            });

            if (response.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }
            if (response.status === 403) {
                alert('접근 권한이 없습니다.');
                return;
            }

            if (!response.ok) {
                const txt = await response.text();
                console.error('Update failed:', txt);
                alert('사용자 정보 수정에 실패했습니다.');
                return;
            }

            if (editModal) editModal.hide();
            loadUsers();
        } catch (e) {
            console.error('Error(updateUser):', e);
            alert('오류가 발생했습니다.');
        } finally {
            toggleSaving(false);
        }
    }

    // 사용자 삭제
    async function deleteUser(userId) {
        if (!confirm('정말로 이 사용자를 삭제하시겠습니까?')) return;

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });

            if (response.status === 401) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login';
                return;
            }
            if (response.status === 403) {
                alert('접근 권한이 없습니다.');
                return;
            }

            if (!response.ok) {
                const txt = await response.text();
                console.error('Delete failed:', txt);
                alert('사용자 삭제에 실패했습니다.');
                return;
            }
            loadUsers();
        } catch (e) {
            console.error('Error(deleteUser):', e);
            alert('오류가 발생했습니다.');
        }
    }

    // 페이지 진입 시: 관리자 권한 확인 + 목록 로딩
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const role  = localStorage.getItem('role');

        if (!token) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        if (role !== 'ROLE_OWNER') {
            alert('관리자만 접근 가능합니다.');
            window.location.href = '/';
            return;
        }

        loadUsers();
    });

    // 저장 버튼 클릭 핸들러
    document.addEventListener('click', (e) => {
        if (e.target.closest('#saveBtn')) {
            updateUser();
        }
    });
</script>
</body>
</html>
