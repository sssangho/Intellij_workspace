<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User CRUD MSA</title>
    <style>
        body { font-family:'Pretendard'; background:#f6f8fa; text-align:center; padding-top:40px;}
        .card { display:inline-block; background:white; padding:30px; border-radius:10px;
            box-shadow:0 3px 10px rgba(0,0,0,0.1); width:600px; position:relative;}
        input { margin:5px; padding:8px; }
        button { padding:8px 12px; margin:5px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;}
        button:hover { background:#0056b3; }
        table { margin-top:20px; border-collapse:collapse; width:100%; }
        th,td { border:1px solid #ccc; padding:8px; }
        th { background:#f0f0f0; }
        #message { color:#555; font-size:14px; margin-top:10px; }
        /* í™”ë©´ ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
        #overlay {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size:18px;
            color:#333;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ‡ RabbitMQ CRUD (MSA)</h2>
    <input id="name" placeholder="ì´ë¦„">
    <input id="email" placeholder="ì´ë©”ì¼">
    <button onclick="createUser()">ì¶”ê°€</button>
    <button onclick="refreshUsers()">ìƒˆë¡œ ê³ ì¹¨</button>
    <hr>
    <div id="message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'ìƒˆë¡œ ê³ ì¹¨' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    <table id="userTable">
        <thead><tr><th>ID</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì•¡ì…˜</th></tr></thead>
        <tbody></tbody>
    </table>
    <div id="overlay">ë°ì´í„° ë¡œë”© ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
</div>

<script>
    async function loadUsers() {
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'flex'; // í™”ë©´ ì ê¸ˆ
        try {
            const res = await fetch('/api/users');
            if (!res.ok) {
                console.error('Server error', res.status, await res.text());
                overlay.style.display = 'none';
                return;
            }
            let users = await res.json();
            if (!Array.isArray(users)) users = [users];

            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4">ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                users.forEach(u => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td>
                                <button onclick="updateUser(${u.id})">ìˆ˜ì •</button>
                                <button onclick="deleteUser(${u.id})">ì‚­ì œ</button>
                            </td>
                        </tr>`;
                });
            }
        } catch (err) {
            console.error('Error loading users', err);
        } finally {
            overlay.style.display = 'none'; // í™”ë©´ ì ê¸ˆ í•´ì œ
        }
    }

    async function refreshUsers() {
        loadUsers();
    }

    async function createUser() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        if (!name || !email) {
            alert('ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        await fetch('/api/users', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name,email})
        });
        loadUsers();
    }

    async function updateUser(id) {
        const name = prompt('ìƒˆ ì´ë¦„:');
        const email = prompt('ìƒˆ ì´ë©”ì¼:');
        if (!name || !email) return;
        await fetch(`/api/users/${id}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({name,email})
        });
        loadUsers();
    }

    async function deleteUser(id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await fetch(`/api/users/${id}`, {method:'DELETE'});
        loadUsers();
    }
</script>
</body>
</html>
